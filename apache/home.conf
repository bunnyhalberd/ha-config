
# Strong TLS config based on Mozilla's TLS config recommendator
SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder     off
SSLSessionTickets       off

SSLUseStapling On
SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

# Redirect anything on tcp/80 to tcp/443
<VirtualHost *:80>
    RewriteEngine On
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
	ServerAdmin webmaster@opsnops.io
	DocumentRoot /var/www/html

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

    ProxyPreserveHost On
    ProxyRequests off
    ProxyPass        "/api/websocket" "ws://localhost:8123/api/websocket"
    ProxyPassReverse "/api/websocket" "ws://localhost:8123/api/websocket"
    ProxyPass        "/"  "http://localhost:8123/"
    ProxyPassReverse "/"  "http://localhost:8123/"

    # Whee trickery with websockets!
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)  ws://localhost:8123/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)  http://localhost:8123/$1 [P,L]

    # Get TLS running
    SSLEngine on
    SSLCertificateFile      /etc/ssl/private/home.opsnlops.io.chained.crt
    SSLCertificateKeyFile   /etc/ssl/private/home.opsnlops.io.key

    # Enable HTTP/2
    Protocols h2 http/1.1

    # HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)
    Header always set Strict-Transport-Security "max-age=63072000"

</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet